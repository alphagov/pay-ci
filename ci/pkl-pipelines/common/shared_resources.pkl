import "package://pkg.pkl-lang.org/github.com/alphagov/pkl-concourse-pipeline/pkl-concourse-pipeline@0.0.1#/Pipeline.pkl"
import "package://pkg.pkl-lang.org/github.com/alphagov/pkl-concourse-pipeline/pkl-concourse-pipeline@0.0.1#/TaskConfig.pkl"

class PayGitHubResource extends Pipeline.Resource {
    type = "git"
    icon = "github"
}

anonymousConcourseRunnerResource = new TaskConfig.AnonymousResource {
    type = "registry-image"
    source = new {
        ["repository"] = "governmentdigitalservice/pay-concourse-runner"
        ["tag"] = "latest"
    }
}

payCiGitHubResource: PayGitHubResource = new {
    name = "pay-ci"
    source = new Mapping {
        ["uri"] = "https://github.com/alphagov/pay-ci"
        ["branch"] = "master"
    }
}

function PayDockerHubResource(resource_name: String, repo: String, tag: String): Pipeline.Resource = new {
    name = resource_name
    type = "registry-image"
    icon = "docker"
    source = new {
        ["repository"] = repo
        ["tag"] = tag
        ["username"] = "((dockerhub-username))"
        ["password"] = "((dockerhub-password))"
    }
}

generateDockerCredsConfigStep = new Pipeline.TaskStep {
    task = "generate-docker-creds-config"
    file = "pay-ci/ci/tasks/generate-docker-config-file.yml"
    params = new {
        ["USERNAME"] = "((docker-username))"
        ["PASSWORD"] = "((docker-password))"
        ["EMAIL"] = "((docker-email))"
    }
}