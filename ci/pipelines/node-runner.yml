---
resources:
  - name: node-runner-src
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-ci
      branch: master
      paths:
        - ci/docker/node-runner/*

  - name: node-runner-latest
    type: registry-image
    icon: docker
    source:
      repository: govukpay/node-runner
      username: ((docker-username))
      password: ((docker-password))
      tag: latest

  - name: node-runner-node12
    type: registry-image
    icon: docker
    source:
      repository: govukpay/node-runner
      username: ((docker-username))
      password: ((docker-password))
      tag: node16

  - name: node-runner-node16
    type: registry-image
    icon: docker
    source:
      repository: govukpay/node-runner
      username: ((docker-username))
      password: ((docker-password))
      tag: node16

# Builds and pushes the node-runner Docker image used by various Concourse CI pipelines
jobs:
  - name: build-and-push
    plan:
      - get: node-runner-src
        trigger: true
      - load_var: source_container_versions
        file: node-runner-src/ci/docker/node-runner/source_container_image_versions.json
        format: json
        reveal: true
      - in_parallel:
        - task: build-node-12
          privileged: true
          output_mapping:
            image: node12-image
          params: 
            CONTEXT: node-runner-src/ci/docker/node-runner
            BUILD_ARG_SOURCE_CONTAINER_IMAGE_VERSION: "((.:source_container_versions.node12.amd64))"
          config:
            platform: linux
            image_resource:
              type: registry-image
              source:
                repository: concourse/oci-build-task
            inputs:
            - name: node-runner-src
            outputs:
            - name: image
            run:
              path: build
        - task: build-node-16
          privileged: true
          output_mapping:
            image: node16-image
          params: 
            CONTEXT: node-runner-src/ci/docker/node-runner
            BUILD_ARG_SOURCE_CONTAINER_IMAGE_VERSION: "((.:source_container_versions.node16.amd64))"
          config:
            platform: linux
            image_resource:
              type: registry-image
              source:
                repository: concourse/oci-build-task
            inputs:
            - name: node-runner-src
            outputs:
            - name: image
            run:
              path: build
      - in_parallel:
        - do:
          - put: node-runner-node12
            params: 
              image: node12-image/image.tar
            get_params:
              skip_download: true
          - put: node-runner-latest
            params: 
              image: node12-image/image.tar
            get_params:
              skip_download: true
        - put: node-runner-node16
          params: 
            image: node16-image/image.tar
          get_params:
            skip_download: true
