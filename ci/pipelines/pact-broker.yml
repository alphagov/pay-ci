---
resource_types:
  - name: cf-cli
    type: docker-image
    source:
      repository: nulldriver/cf-cli-resource

  - name: slack-notification
    type: docker-image
    source:
      repository: cfcommunity/slack-notification-resource
      tag: latest

resources:
  - name: pact-broker-pipeline
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-ci
      branch: master
      paths:
        - ci/pipelines/pact-broker.yml

  - name: pact-broker-manifest
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-ci
      branch: master
      paths:
        - ci/pact_broker

  - name: paas
    type: cf-cli
    icon: cloud-upload-outline
    source:
      api: https://api.cloud.service.gov.uk
      org: govuk-pay
      space: build
      username: ((cf-username))
      password: ((cf-password))
      cf_cli_version: 7

  - name: pact-broker-src
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-ci
      branch: master
      paths:
        - ci/docker/pact-broker/*

  - name: pay-ci
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-ci
      branch: master

  - name: pact-broker-ecr-registry-test
    type: registry-image
    icon: docker
    source:
      repository: govukpay/pact-broker
      tag: "2.54.0.0" # hardcoding this tag as we don't want to upgrade to a new version of pact broker in the process of moving it. we will get the value for this tag field in a separate story.
      aws_access_key_id: ((readonly_access_key_id))
      aws_secret_access_key: ((readonly_secret_access_key))
      aws_session_token: ((readonly_session_token))
      aws_role_arn: arn:aws:iam::((pay_aws_deploy_account_id)):role/concourse
      aws_ecr_registry_id: "((pay_aws_deploy_account_id))"
      aws_region: eu-west-1

  - name: slack-notification
    type: slack-notification
    source:
      url: https://hooks.slack.com/services/((slack-notification-secret))

jobs:
  - name: set-pipeline
    plan:
      - get: pact-broker-pipeline
        trigger: true
      - set_pipeline: pact-broker
        file: pact-broker-pipeline/ci/pipelines/pact-broker.yml
  
  - name: deploy-pact-broker
    serial: true
    plan:
      - get: pact-broker-manifest
        trigger: true
      - put: paas
        params:
          command: zero-downtime-push
          current_app_name: pay-pact-broker
          manifest: pact-broker-manifest/ci/pact_broker/pay-pact-broker_manifest.yml
          vars:
            pact-broker-username: ((pact-broker-username))
            pact-broker-password: ((pact-broker-password))
  # Builds the Docker images used by pact-broker and pushes to ECR
  - name: build-and-push-pact-broker
    plan:
      - in_parallel:
        - get: pact-broker-src
          trigger: true
        - get: pay-ci
      - task: generate-docker-creds-config
        file: pay-ci/ci/tasks/generate-docker-config-file.yml
        params:
          USERNAME: ((docker-username))
          PASSWORD: ((docker-access-token))
          EMAIL: ((docker-email))
      - task: build-pact-broker-image
        privileged: true
        params:
          CONTEXT: pact-broker-src/ci/docker/pact-broker
          DOCKER_CONFIG: docker_creds
          UNPACK_ROOTFS: true
        config:
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: concourse/oci-build-task
          inputs:
            - name: pact-broker-src
            - name: docker_creds
          outputs:
            - name: image
          run:
            path: build
      - put: pact-broker-ecr-registry-test
        params:
          image: image/image.tar
        get_params:
          skip_download: true
    on_failure:
      put: slack-notification
      attempts: 10
      params:
        channel: "#govuk-pay-starling"
        silent: true
        text: ":red-circle: Failed to build and push pay-pact-broker image - <https://pay-cd.deploy.payments.service.gov.uk/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|Concourse build #$BUILD_NAME>"
        icon_emoji: ":concourse:"
        username: pay-concourse
    on_success:
      put: slack-notification
      attempts: 10
      params:
        channel: "#govuk-pay-activity"
        silent: true
        text: ":green-circle: Built and pushed pay-pact-broker image - <https://pay-cd.deploy.payments.service.gov.uk/teams/$BUILD_TEAM_NAME/pipelines/$BUILD_PIPELINE_NAME/jobs/$BUILD_JOB_NAME/builds/$BUILD_NAME|Concourse build #$BUILD_NAME>"
        icon_emoji: ":concourse:"
        username: pay-concourse
