---
platform: linux
image_resource:
  type: registry-image
  source:
    repository: govukpay/concourse-runner
params:
  AWS_ACCESS_KEY_ID:
  AWS_SECRET_ACCESS_KEY:
  AWS_SESSION_TOKEN:    
  AWS_REGION: eu-west-1
  ENVIRONMENT:
run:
  path: /bin/bash
  args:
    - -ec
    - |
      for canary in notifcatns_sndbx pymntlnk_sandbox cancel_sandbox card_wpay_3ds2ex \
      card_wpay_3ds2 card_wpay_3ds card_wpay card_stripe_3ds card_stripe card_sandbox \
      s_card_stripe s_card_stripe_3d s_card_wpay s_card_wpay_3ds s_card_wpay_3ds2 \
      s_wpay_3ds2ex s_card_sandbox s_cancel_sandbox s_paylnk_sandbox s_notifications; do

        canary_name="${canary}_${ENVIRONMENT}"

        status=$(aws --region "$AWS_REGION" synthetics get-canary --name "$canary_name" | jq -r '.Canary.Status.State')
        if [ "$status" == "ERROR" ]
        then  
          echo "Canary $canary_name is in an errored state. It must be manually deleted and created - see https://pay-team-manual.cloudapps.digital/manual/tools/canary.html#updating-canary-tests-in-error-state."
          exit 1
        elif [[ "$status" == *"Canary not found"* ]]
        then
          echo "Canary $canary_name not found. This is ok if it's the test environment and the canary is a scheduled one."
        fi
      done