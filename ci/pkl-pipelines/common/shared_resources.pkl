import "package://pkg.pkl-lang.org/github.com/alphagov/pkl-concourse-pipeline/pkl-concourse-pipeline@0.0.1#/Pipeline.pkl"
import "package://pkg.pkl-lang.org/github.com/alphagov/pkl-concourse-pipeline/pkl-concourse-pipeline@0.0.1#/TaskConfig.pkl"

class PayGitHubResource extends Pipeline.Resource {
    type = "git"
    icon = "github"
}

function PayGithubPullRequestResource(_name: String, alphagovRepo: String): Pipeline.Resource = new {
    name = _name
    type = "git"
    icon = "github"
    source = new {
        ["disable_forks"] = true
        ["repository"] = "alphagov/\(alphagovRepo)"
        ["access-token"] = "((github-access-token))"
    }
}

pullRequestResourceType = new Pipeline.ResourceType {
    name = "pull-request"
    type = "registry-image"
    source = new {
        ["respository"] = "teliaoss/github-pr-resource"
        ["tag"] = "v0.23.0"
    }
}

function PutPRTestPendingStatus(resourceName: String): Pipeline.PutStep = new {
    put = resourceName
    get_params {
        ["skip_download"] = true
    }
    params {
        ["path"] = resourceName
        ["status"] = "pending"
        ["context"] = "test"
    }
}

function PutPRTestSuccessStatus(resourceName: String): Pipeline.PutStep = new {
    put = resourceName
    get_params {
        ["skip_download"] = true
    }
    params {
        ["path"] = resourceName
        ["status"] = "success"
        ["context"] = "test"
    }
}

function PutPRTestFailedStatus(resourceName: String): Pipeline.PutStep = new {
    put = resourceName
    get_params {
        ["skip_download"] = true
    }
    params {
        ["path"] = resourceName
        ["status"] = "failed"
        ["context"] = "test"
    }
}

anonymousConcourseRunnerResource = new TaskConfig.AnonymousResource {
    type = "registry-image"
    source = new {
        ["repository"] = "governmentdigitalservice/pay-concourse-runner"
        ["tag"] = "latest"
    }
}

payCiGitHubResource: PayGitHubResource = new {
    name = "pay-ci"
    source = new Mapping {
        ["uri"] = "https://github.com/alphagov/pay-ci"
        ["branch"] = "master"
    }
}

function PayDockerHubResource(resource_name: String, repo: String, tag: String): Pipeline.Resource = new {
    name = resource_name
    type = "registry-image"
    icon = "docker"
    source = new {
        ["repository"] = repo
        ["tag"] = tag
        ["username"] = "((dockerhub-username))"
        ["password"] = "((dockerhub-password))"
    }
}

generateDockerCredsConfigStep = new Pipeline.TaskStep {
    task = "generate-docker-creds-config"
    file = "pay-ci/ci/tasks/generate-docker-config-file.yml"
    params = new {
        ["USERNAME"] = "((docker-username))"
        ["PASSWORD"] = "((docker-password))"
        ["EMAIL"] = "((docker-email))"
    }
}