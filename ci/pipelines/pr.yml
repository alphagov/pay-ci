definitions:
  - &job-definition
    name: updateThisValue
    max_in_flight: 3
    build_log_retention:
      builds: 500
  - &get-pull-request
    get: src
    resource: updateThisValue
    trigger: false
    version: every
    params:
      integration_tool: checkout
  - &get-ci
    get: ci
    resource: ci
    trigger: false
  - &put-unit-tests-pending-status
    put: updateThisValue
    params:
      path: src
      status: pending
      context: unit tests
  - &run-java-package
    task: run-java-package
    file: ci/ci/tasks/java-package.yml
  - &run-java-unit-test
    task: run-unit-tests
    file: ci/ci/tasks/java-tests.yml
    params:
      app_name: updateThisValue
    on_failure:
      &put-unit-test-failed-status
      put: updateThisValue
      params:
        path: src
        status: failure
        context: unit tests
  - &put-unit-test-success-status
    put: updateThisValue
    params:
      path: src
      status: success
      context: unit tests
  - &build-docker-image
    task: build-image
    privileged: true
    file: ci/ci/tasks/build-docker-image.yml
    params:
      app_name: updateThisValue
  - &put-s3-docker-image
    put: s3-docker-images
    params:
      file: local_image/*.tar
  - &put-s3-build
    put: s3-builds
    params:
      file: zipped_build/*.tar.gz
  - &put-integration-test-pending-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: pending
      context: integration tests
  - &run-java-integration-tests
    task: run-integration-tests
    privileged: true
    file: ci/ci/tasks/java-integration-tests.yml
    on_failure:
      &put-integration-test-failed-status
      put: updateThisValue
      get_params:
        skip_download: true
      params:
        path: src
        status: failure
        context: integration tests
  - &send-pr-build-time
    task: send pr build time to Hosted Graphite
    params:
      GITHUB_API_TOKEN: ((github-access-token))
      HOSTED_GRAPHITE_ACCOUNT_ID: ((HOSTED_GRAPHITE_ACCOUNT_ID))
      HOSTED_GRAPHITE_API_TOKEN: ((HOSTED_GRAPHITE_API_KEY))
    config:
      platform: linux
      image_resource:
        type: registry-image
        source:
          repository: govukpay/pay-pr-flow-stats
      inputs:
        - name: src
      run:
        path: sh
        args:
          - -ec
          - |
            REPO=$(grep -o "alphagov/.[^/]*" src/.git/resource/url)
            PR_NUMBER="$(cat src/.git/resource/pr)"
            echo "Sending pr build time for pr ${PR_NUMBER}"
            /pay-pr-flow-stats/bin/flow_check -q --repo "$REPO" \
                    --pr "$PR_NUMBER"  --send-to-hg --filter-manually-triggered
  - &put-integration-test-success-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: success
      context: integration tests
  - &get-local-docker-image
    get: s3-docker-images
    trigger: true
    passed: [updateThisValue]
    params:
      filename: image-updateThisValue-*.tar
  - &put-card-e2e-pending-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: pending
      context: card e2e tests
  - &run-e2e
    task: run e2e tests
    privileged: true
    file: ci/ci/tasks/endtoend/task.yml
    input_mapping:
      docker/connector: updateThisValue
    params:
      app_name: updateThisValue
      test_type: updateThisValue
  - &put-card-e2e-failed-status
    put: card-connector-pull-request
    get_params:
      skip_download: true
    params:
      path: src
      status: failure
      context: card e2e tests
  - &put-card-e2e-success-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: success
      context: card e2e tests
  - &put-test-failed-status
    put: card-connector-pull-request
    get_params:
      skip_download: true
    params:
      path: src
      status: failure
      context: test
  - &put-test-success-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: success
      context: test
  - &put-test-pending-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: pending
      context: test
  - &put-products-e2e-pending-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: pending
      context: products e2e tests
  - &put-products-e2e-failed-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: failure
      context: products e2e tests
  - &put-products-e2e-success-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: success
      context: products e2e tests
  - &node-test
    task: test
    file: ci/ci/tasks/node-build-pr.yml
  - &node-build
    task: build
    file: ci/ci/tasks/node-build-pr.yml
    params:
      skip_tests: true
  - x-pact-credentials: &pact-credentials
      pact-broker-username: ((pact-broker-username))
      pact-broker-password: ((pact-broker-password))
  - &publish-pacts
    task: publish pacts
    vars:
      <<: *pact-credentials
    params:
      consumer_name: updateThisValue
    file: ci/ci/tasks/publish-pacts.yml
  - &zip-build
    task: zip-build
    file: ci/ci/tasks/zip-build.yml
    params:
      app_name: updateThisValue
  - &put-node-test-failure
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: failure
      context: node test
  - &get-all-docker-images
    in_parallel:
      fail_fast: true
      steps: &docker-image-list
        - get: docker/publicapi
          resource: publicapi
          params:
            format: oci
        - get: docker/frontend
          resource: card-frontend
          params:
            format: oci
        - get: docker/reverse_proxy
          resource: reverse_proxy
          params:
            format: oci
        - get: docker/postgres
          resource: postgres
          params:
            format: oci
        - get: docker/sqs
          resource: sqs
          params:
            format: oci
        - get: docker/adminusers
          resource: adminusers
          params:
            format: oci
        - get: docker/selfservice
          resource: selfservice
          params:
            format: oci
        - get: docker/connector
          resource: card-connector
          params:
            format: oci
        - get: docker/ledger
          resource: ledger
          params:
            format: oci
        - get: docker/publicauth
          resource: publicauth
          params:
            format: oci
        - get: docker/stubs
          resource: stubs
          params:
            format: oci
        - get: docker/cardid
          resource: cardid
          params:
            format: oci
        - get: docker/endtoend
          resource: endtoend
          params:
            format: oci
        - get: docker/selenium
          resource: selenium
          params:
            format: oci
        - get: docker/products
          resource: products
          params:
            format: oci
        - get: docker/products-ui
          resource: products-ui
          params:
            format: oci
  - &put-pact-provider-pending-status
    put: updateThisValue
    get_params:
      skip_download: true
    params:
      path: src
      status: pending
      context: pact provider verification
  - &put-pact-provider-success-status
    put: updateThisValue
    params:
      path: src
      status: success
      context: pact provider verification
  - &put-pact-provider-failed-status
    put: updateThisValue
    params:
      path: src
      status: failure
      context: pact provider verification
  - &pact-provider-verification
    task: pact verification
    privileged: true
    file: ci/ci/tasks/pact-provider-verification.yml
    vars:
      <<: *pact-credentials
    params:
      consumer: updateThisValue
      provider: updateThisValue
  - &pact-provider-test-preflight-check
    task: check is valid
    file: ci/ci/tasks/pact-provider-test-preflight-check.yml
    vars:
      <<: *pact-credentials
    params:
      consumer:

groups:
  - name: Card Connector
    jobs:
      - card-connector-unit-test
      - card-connector-integration-test
      - card-connector-pact-provider-test
      - card-connector-pact-provider-verification
      - card-connector-card-e2e
      - record-connector-build-time


  - name: End To End
    jobs:
      - endtoend-card-e2e
      - endtoend-products-e2e
      - record-endtoend-build-time

  - name: Publicapi
    jobs:
      - publicapi-unit-test
      - publicapi-integration-test
      - publicapi-card-e2e
      - publicapi-products-e2e
      - publicapi-pact-provider-verification
      - record-publicapi-build-time

  - name: Adminusers
    jobs:
      - adminusers-unit-test
      - adminusers-integration-test
      - adminusers-card-e2e
      - adminusers-pact-provider-test
      - record-adminusers-build-time

  - name: Cardid
    jobs:
      - cardid-unit-test
      - cardid-integration-test
      - cardid-card-e2e
      - record-cardid-build-time

  - name: Ledger
    jobs:
      - ledger-unit-test
      - ledger-integration-test
      - ledger-consumer-pact-test
      - ledger-pact-provider-test
      - ledger-pact-provider-verification
      - ledger-card-e2e
      - record-ledger-build-time

  - name: Publicauth
    jobs:
      - publicauth-unit-test
      - publicauth-integration-test
      - publicauth-card-e2e
      - record-publicauth-build-time

  - name: Products
    jobs:
      - products-unit-test
      - products-integration-test
      - products-pact-provider-test
      - products-products-e2e
      - record-products-build-time

  - name: Products-UI
    jobs:
      - products-ui-test
      - products-ui-products-e2e
      - products-ui-pact-provider-verification
      - record-products-ui-build-time

  - name: Card-Frontend
    jobs:
      - card-frontend-test
      - card-frontend-card-e2e
      - card-frontend-pact-provider-verification
      - record-frontend-build-time

  - name: Selfservice
    jobs:
      - selfservice-test
      - selfservice-card-e2e
      - selfservice-pact-provider-verification
      - record-selfservice-build-time

  - name: Toolbox
    jobs:
      - toolbox-test
      - record-toolbox-build-time

  - name: Java-Commons
    jobs:
      - java-commons-test
      - record-java-commons-build-time

  - name: Update-Pipeline
    jobs:
      - update-pr-ci-pipeline

  - name: ci
    jobs:
      - ci-pr-test

  - name: Stubs
    jobs:
      - stubs-test
      - record-stubs-build-time

resource_types:
  - name: pull-request
    type: registry-image
    source:
      repository: teliaoss/github-pr-resource
      tag: v0.21.0

  - name: paas-s3
    type: registry-image
    source:
      repository: govukpay/concourse-s3-resource

resources:
  - name: card-connector-master
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-connector
      branch: master
  - name: ledger-master
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-ledger
      branch: master
  - name: adminusers-master
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-adminusers
      branch: master
  - name: products-master
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-products
      branch: master
  - name: pr-ci-pipeline
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-ci
      branch: master
      paths:
        - ci/pipelines/pr.yml

  - name: ci
    type: git
    icon: github
    source:
      uri: https://github.com/alphagov/pay-ci
      branch: master
      username: alphagov-pay-ci
      password: ((github-access-token))

  - &image
    name: adminusers
    type: registry-image
    icon: docker
    source: &image-source
      repository: govukpay/adminusers
      tag: latest-master
      password: ((docker-password))
      username: ((docker-username))

  - <<: *image
    name: cardid
    source:
      <<: *image-source
      repository: govukpay/cardid

  - <<: *image
    name: card-connector
    source:
      <<: *image-source
      repository: govukpay/connector

  - <<: *image
    name: card-frontend
    source:
      <<: *image-source
      repository: govukpay/frontend

  - <<: *image
    name: ledger
    source:
      <<: *image-source
      repository: govukpay/ledger

  - <<: *image
    name: publicapi
    source:
      <<: *image-source
      repository: govukpay/publicapi

  - <<: *image
    name: publicauth
    source:
      <<: *image-source
      repository: govukpay/publicauth

  - <<: *image
    name: products-ui
    source:
      <<: *image-source
      repository: govukpay/products-ui

  - <<: *image
    name: products
    source:
      <<: *image-source
      repository: govukpay/products

  - <<: *image
    name: selfservice
    source:
      <<: *image-source
      repository: govukpay/selfservice

  - <<: *image
    name: reverse_proxy
    source:
      <<: *image-source
      repository: govukpay/reverse-proxy

  - <<: *image
    name: stubs
    source:
      <<: *image-source
      repository: govukpay/stubs

  - <<: *image
    name: sqs
    source:
      <<: *image-source
      repository: roribio16/alpine-sqs
      tag: latest

  - <<: *image
    name: postgres
    source:
      <<: *image-source
      repository: postgres
      tag: 11-alpine

  - <<: *image
    name: selenium
    source:
      <<: *image-source
      repository: selenium/standalone-chrome
      tag: 3.141.59-iron

  - <<: *image
    name: endtoend
    source:
      <<: *image-source
      repository: govukpay/endtoend
      tag: latest-master

  - &pull-request
    name: card-connector-pull-request
    type: pull-request
    icon: github
    source: &pull-request-source
      disable_forks: true
      repository: alphagov/pay-connector
      access_token: ((github-access-token))

  - <<: *pull-request
    name: endtoend-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-endtoend

  - <<: *pull-request
    name: java-commons-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-java-commons

  - <<: *pull-request
    name: adminusers-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-adminusers

  - <<: *pull-request
    name: publicapi-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-publicapi

  - <<: *pull-request
    name: ledger-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-ledger

  - <<: *pull-request
    name: publicauth-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-publicauth

  - <<: *pull-request
    name: cardid-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-cardid

  - <<: *pull-request
    name: card-frontend-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-frontend

  - <<: *pull-request
    name: selfservice-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-selfservice

  - <<: *pull-request
    name: toolbox-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-toolbox

  - <<: *pull-request
    name: products-ui-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-products-ui

  - <<: *pull-request
    name: products-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-products

  - <<: *pull-request
    name: stubs-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-stubs

  - <<: *pull-request
    name: ci-pull-request
    source:
      <<: *pull-request-source
      repository: alphagov/pay-ci
      paths:
        - "ci/pipelines/*"
        - "ci/tasks/*"

jobs:
  - <<: *job-definition
    name: card-connector-unit-test
    serial_groups: [unit-test]
    plan:
    - <<: *get-pull-request
      resource: card-connector-pull-request
    - <<: *get-ci
    - <<: *put-unit-tests-pending-status
      put: card-connector-pull-request
    - <<: *run-java-unit-test
      params:
        app_name: connector
      on_failure:
        <<: *put-unit-test-failed-status
        put: card-connector-pull-request
    - <<: *put-unit-test-success-status
      put: card-connector-pull-request

  - <<: *job-definition
    name: card-connector-integration-test
    serial_groups: [integration-test]
    plan:
    - <<: *get-pull-request
      resource: card-connector-pull-request
    - <<: *put-integration-test-pending-status
      put: card-connector-pull-request
    - <<: *get-ci
    - <<: *run-java-integration-tests
      on_failure:
        <<: *put-integration-test-failed-status
        put: card-connector-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: connector
    - <<: *put-integration-test-success-status
      put: card-connector-pull-request

  - <<: *job-definition
    name: card-connector-pact-provider-test
    serial_groups: [pact-test]
    plan:
    - <<: *get-pull-request
      resource: card-connector-pull-request
    - <<: *put-pact-provider-pending-status
      put: card-connector-pull-request
    - <<: *get-ci
    - <<: *pact-provider-test-preflight-check
    - <<: *pact-provider-verification
      input_mapping:
        test_target: src
      params:
        provider: connector
      on_failure:
        <<: *put-pact-provider-failed-status
        put: card-connector-pull-request
    - <<: *put-pact-provider-success-status
      put: card-connector-pull-request

  - <<: *job-definition
    name: card-connector-pact-provider-verification
    serial_groups: [pact-test]
    plan:
      - <<: *get-ci
      - <<: *get-pull-request
        resource: card-connector-pull-request
        passed: [card-connector-unit-test, card-connector-integration-test]
      - <<: *put-pact-provider-pending-status
        put: card-connector-pull-request
      - get: ledger-master
      - <<: *pact-provider-test-preflight-check
        params:
          consumer: connector
      - <<: *pact-provider-verification
        task: ledger provider pact verification
        input_mapping:
          test_target: ledger-master
        params:
          consumer: connector
          provider: ledger
        on_failure:
          <<: *put-pact-provider-failed-status
          put: card-connector-pull-request
      - <<: *put-pact-provider-success-status
        put: card-connector-pull-request

  - <<: *job-definition
    name: card-connector-card-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        resource: card-connector-pull-request
        trigger: false
        passed: [card-connector-unit-test]
      - <<: *get-ci
      - <<: *put-card-e2e-pending-status
        put: card-connector-pull-request
      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: connector
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/connector: local_image
        params:
          app_name: connector
          test_type: card
        on_failure:
          <<: *put-card-e2e-failed-status
          put: card-connector-pull-request
      - <<: *put-card-e2e-success-status
        put: card-connector-pull-request

  - <<: *job-definition
    name: record-connector-build-time
    plan:
    - <<: *get-pull-request
      resource: card-connector-pull-request
      passed: [card-connector-unit-test, card-connector-integration-test,
        card-connector-pact-provider-test, card-connector-pact-provider-verification]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: endtoend-products-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        resource: endtoend-pull-request
      - <<: *get-ci
      - <<: *put-products-e2e-pending-status
        put: endtoend-pull-request
      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: endtoend
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/endtoend: local_image
        params:
          app_name: endtoend
          test_type: products
        on_failure:
          <<: *put-products-e2e-failed-status
          put: endtoend-pull-request
      - <<: *put-products-e2e-success-status
        put: endtoend-pull-request

  - <<: *job-definition
    name: endtoend-card-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        resource: endtoend-pull-request
      - <<: *get-ci
      - <<: *put-card-e2e-pending-status
        put: endtoend-pull-request
      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: endtoend
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/endtoend: local_image
        params:
          app_name: endtoend
          test_type: card
        on_failure:
          <<: *put-card-e2e-failed-status
          put: endtoend-pull-request
      - <<: *put-card-e2e-success-status
        put: endtoend-pull-request

  - <<: *job-definition
    name: record-endtoend-build-time
    plan:
    - <<: *get-pull-request
      resource: endtoend-pull-request
      passed: [endtoend-products-e2e, endtoend-card-e2e]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: publicapi-unit-test
    serial_groups: [unit-test]
    plan:
    - <<: *get-pull-request
      resource: publicapi-pull-request
    - <<: *get-ci
    - <<: *put-unit-tests-pending-status
      put: publicapi-pull-request
    - <<: *run-java-unit-test
      params:
        app_name: publicapi
      on_failure:
        <<: *put-unit-test-failed-status
        put: publicapi-pull-request
    - <<: *put-unit-test-success-status
      put: publicapi-pull-request

  - <<: *job-definition
    name: publicapi-integration-test
    serial_groups: [integration-test]
    plan:
    - <<: *get-pull-request
      resource: publicapi-pull-request
    - <<: *put-integration-test-pending-status
      put: publicapi-pull-request
    - <<: *get-ci
    - <<: *run-java-integration-tests
      on_failure:
        <<: *put-integration-test-failed-status
        put: publicapi-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: publicapi
    - <<: *put-integration-test-success-status
      put: publicapi-pull-request

  - <<: *job-definition
    name: publicapi-card-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        resource: publicapi-pull-request
        trigger: false
        passed: [publicapi-unit-test]
      - <<: *get-ci
      - <<: *put-card-e2e-pending-status
        put: publicapi-pull-request
      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: publicapi
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/publicapi: local_image
        params:
          app_name: publicapi
          test_type: card
        on_failure:
          <<: *put-card-e2e-failed-status
          put: publicapi-pull-request
      - <<: *put-card-e2e-success-status
        put: publicapi-pull-request

  - name: publicapi-pact-provider-verification
    serial_groups: [pact-test]
    plan:
      - <<: *get-pull-request
        resource: publicapi-pull-request
        passed: [publicapi-unit-test, publicapi-integration-test]
      - <<: *put-pact-provider-pending-status
        put: publicapi-pull-request
      - <<: *get-ci
      - get: card-connector-master
      - get: ledger-master
      - <<: *pact-provider-test-preflight-check
        params:
          consumer: publicapi
      - in_parallel:
        - <<: *pact-provider-verification
          task: connector provider pact verification
          input_mapping:
            test_target: card-connector-master
          params:
            consumer: publicapi
            provider: connector
        - <<: *pact-provider-verification
          task: ledger provider pact verification
          input_mapping:
            test_target: ledger-master
          params:
            consumer: publicapi
            provider: ledger
        on_failure:
          <<: *put-pact-provider-failed-status
          put: publicapi-pull-request
      - <<: *put-pact-provider-success-status
        put: publicapi-pull-request

  - <<: *job-definition
    name: publicapi-products-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        resource: publicapi-pull-request
        trigger: false
        passed: [publicapi-unit-test]
      - <<: *get-ci
      - <<: *put-products-e2e-pending-status
        put: publicapi-pull-request
      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: publicapi
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/publicapi: local_image
        params:
          app_name: publicapi
          test_type: products
        on_failure:
          <<: *put-products-e2e-failed-status
          put: publicapi-pull-request
      - <<: *put-products-e2e-success-status
        put: publicapi-pull-request

  - <<: *job-definition
    name: record-publicapi-build-time
    plan:
    - <<: *get-pull-request
      resource: publicapi-pull-request
      passed: [publicapi-unit-test, publicapi-integration-test,
        publicapi-pact-provider-verification]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: java-commons-test
    plan:
    - <<: *get-pull-request
      resource: java-commons-pull-request
    - <<: *get-ci
    - <<: *put-integration-test-pending-status
      put: java-commons-pull-request
    - task: test
      config:
        container_limits: {}
        image_resource:
          type: registry-image
          source:
            repository: maven
            tag: 3.8.1-adoptopenjdk-11
        caches:
          - path: src/.m2
        inputs:
          - name: src
        platform: linux
        run:
          path: bash
          dir: src
          args:
          - -ec
          - |
            export MAVEN_HOME=/usr/lib/mvn
            export PATH=$MAVEN_HOME/bin:$PATH
            export MAVEN_REPO="$PWD/.m2"

            cat <<'EOF' >settings.xml
            <settings xmlns="http://maven.apache.org/SETTINGS/1.0.0"
                  xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                  xsi:schemaLocation="http://maven.apache.org/SETTINGS/1.0.0
                                      https://maven.apache.org/xsd/settings-1.0.0.xsd">
                  <localRepository>${env.MAVEN_REPO}</localRepository>
            </settings>
            EOF

            mvn --global-settings settings.xml clean install
      on_failure:
        <<: *put-integration-test-failed-status
        put: java-commons-pull-request
    - <<: *put-integration-test-success-status
      put: java-commons-pull-request

  - <<: *job-definition
    name: record-java-commons-build-time
    plan:
    - <<: *get-pull-request
      resource: java-commons-pull-request
      passed: [java-commons-test]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: adminusers-unit-test
    serial_groups: [unit-test]
    plan:
    - <<: *get-pull-request
      resource: adminusers-pull-request
    - <<: *get-ci
    - <<: *put-unit-tests-pending-status
      put: adminusers-pull-request
    - <<: *run-java-unit-test
      params:
        app_name: adminusers
      on_failure:
        <<: *put-unit-test-failed-status
        put: adminusers-pull-request
    - <<: *put-unit-test-success-status
      put: adminusers-pull-request

  - <<: *job-definition
    name: adminusers-integration-test
    serial_groups: [integration-test]
    plan:
    - <<: *get-pull-request
      resource: adminusers-pull-request
    - <<: *put-integration-test-pending-status
      put: adminusers-pull-request
    - <<: *get-ci
    - <<: *run-java-integration-tests
      on_failure:
        <<: *put-integration-test-failed-status
        put: adminusers-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: adminusers
    - <<: *put-integration-test-success-status
      put: adminusers-pull-request

  - <<: *job-definition
    name: adminusers-pact-provider-test
    serial_groups: [pact-test]
    plan:
    - <<: *get-pull-request
      resource: adminusers-pull-request
    - <<: *put-pact-provider-pending-status
      put: adminusers-pull-request
    - <<: *get-ci
    - <<: *pact-provider-test-preflight-check
    - <<: *pact-provider-verification
      input_mapping:
        test_target: src
      params:
        provider: adminusers
      on_failure:
        <<: *put-pact-provider-failed-status
        put: adminusers-pull-request
    - <<: *put-pact-provider-success-status
      put: adminusers-pull-request

  - <<: *job-definition
    name: adminusers-card-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        trigger: false
        resource: adminusers-pull-request
        passed: [adminusers-unit-test]
      - <<: *get-ci
      - <<: *put-card-e2e-pending-status
        put: adminusers-pull-request
      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: adminusers
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/adminusers: local_image
        params:
          app_name: adminusers
          test_type: card
        on_failure:
          <<: *put-card-e2e-failed-status
          put: adminusers-pull-request
      - <<: *put-card-e2e-success-status
        put: adminusers-pull-request

  - <<: *job-definition
    name: record-adminusers-build-time
    plan:
    - <<: *get-pull-request
      resource: adminusers-pull-request
      passed: [adminusers-unit-test, adminusers-integration-test,
        adminusers-pact-provider-test]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: cardid-unit-test
    serial_groups: [unit-test]
    plan:
    - <<: *get-pull-request
      resource: cardid-pull-request
    - <<: *get-ci
    - <<: *put-unit-tests-pending-status
      put: cardid-pull-request
    - <<: *run-java-unit-test
      params:
        app_name: cardid
      on_failure:
        <<: *put-unit-test-failed-status
        put: cardid-pull-request
    - <<: *put-unit-test-success-status
      put: cardid-pull-request

  - <<: *job-definition
    name: cardid-integration-test
    serial_groups: [integration-test]
    plan:
    - <<: *get-pull-request
      resource: cardid-pull-request
    - <<: *put-integration-test-pending-status
      put: cardid-pull-request
    - <<: *get-ci
    - <<: *run-java-integration-tests
      on_failure:
        <<: *put-integration-test-failed-status
        put: cardid-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: cardid
    - <<: *put-integration-test-success-status
      put: cardid-pull-request

  - <<: *job-definition
    name: cardid-card-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        resource: cardid-pull-request
        trigger: false
      - <<: *get-ci
      - <<: *put-card-e2e-pending-status
        put: cardid-pull-request
      - task: update submodule
        config:
          container_limits: {}
          platform: linux
          image_resource:
            type: registry-image
            source:
              repository: govukpay/concourse-runner
          inputs:
            - name: src
          params:
            GH_ACCESS_TOKEN: ((github-access-token))
          outputs:
            - name: src
          run:
            path: bash
            dir: src
            args:
              - -ec
              - |
                # cardid-data submodule's url is defined as ssh yet concourse
                # is using oauth. Furthermore we need to avoid the password
                # prompt from the git cli. Therefore rewrite the url for https
                # and add the token. The risk of setting the token in the url is
                # mitigated since these files are not committed, the container is ephemeral
                # and anyone with access to read the files could read the token from
                # environment variable. Furthermore we redact the token from the
                # files after the update.
                sed -i "s/git@github.com:/https:\/\/${GH_ACCESS_TOKEN}@github.com\//" .gitmodules
                git submodule init -q data
                git submodule update data
                sed -i "s/${GH_ACCESS_TOKEN}/token_redacted/" .gitmodules
                sed -i "s/${GH_ACCESS_TOKEN}/token_redacted/" .git/config

      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: cardid
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/cardid: local_image
        params:
          app_name: cardid
          test_type: card
        on_failure:
          <<: *put-card-e2e-failed-status
          put: cardid-pull-request
      - <<: *put-card-e2e-success-status
        put: cardid-pull-request

  - <<: *job-definition
    name: record-cardid-build-time
    plan:
    - <<: *get-pull-request
      resource: cardid-pull-request
      passed: [cardid-unit-test, cardid-integration-test]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: ledger-unit-test
    serial_groups: [unit-test]
    plan:
    - <<: *get-pull-request
      resource: ledger-pull-request
    - <<: *get-ci
    - <<: *put-unit-tests-pending-status
      put: ledger-pull-request
    - <<: *run-java-unit-test
      params:
        app_name: ledger
      on_failure:
        <<: *put-unit-test-failed-status
        put: ledger-pull-request
    - <<: *put-unit-test-success-status
      put: ledger-pull-request

  - <<: *job-definition
    name: ledger-integration-test
    serial_groups: [integration-test]
    plan:
    - <<: *get-pull-request
      resource: ledger-pull-request
    - <<: *put-integration-test-pending-status
      put: ledger-pull-request
    - <<: *get-ci
    - <<: *run-java-integration-tests
      on_failure:
        <<: *put-integration-test-failed-status
        put: ledger-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: ledger
    - <<: *put-integration-test-success-status
      put: ledger-pull-request

  - <<: *job-definition
    name: ledger-pact-provider-test
    serial_groups: [pact-test]
    plan:
    - <<: *get-pull-request
      resource: ledger-pull-request
    - <<: *put-pact-provider-pending-status
      put: ledger-pull-request
    - <<: *get-ci
    - <<: *pact-provider-test-preflight-check
    - <<: *pact-provider-verification
      input_mapping:
        test_target: src
      params:
        provider: ledger
      on_failure:
        <<: *put-pact-provider-failed-status
        put: ledger-pull-request
    - <<: *put-pact-provider-success-status
      put: ledger-pull-request

  - <<: *job-definition
    name: ledger-consumer-pact-test
    plan:
    - <<: *get-ci
    - <<: *get-pull-request
      resource: ledger-pull-request
    - task: run consumer pact tests
      privileged: true
      config:
        container_limits: {}
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: govukpay/concourse-runner
        inputs:
          - name: src
        outputs:
          - name: pacts
        run:
          path: sh
          dir: src
          args:
            - -ec
            - |
              source /docker-helpers.sh
              start_docker

              function cleanup {
                echo "CLEANUP TRIGGERED"
                clean_docker
                stop_docker
                echo "CLEANUP COMPLETE"
              }

              trap cleanup EXIT

              commit="$(cat .git/resource/head_sha)"
              pr="$(cat .git/resource/pr)"
              mvn clean package \
                        -DPACT_BROKER_URL=https://pact-broker-test.cloudapps.digital \
                        -DPACT_BROKER_USERNAME="" \
                        -DPACT_BROKER_PASSWORD="" \
                        -DPACT_CONSUMER_VERSION=${commit} \
                        -DPACT_CONSUMER_TAG=${pr} \
                        -Dpact.provider.version=${commit} \
                        -DrunConsumerContractTests=true
              cp -R target/pacts/* ../pacts/ || true

    - <<: *publish-pacts
      params:
        consumer_name: ledger

  - <<: *job-definition
    name: ledger-pact-provider-verification
    serial_groups: [pact-test]
    plan:
      - <<: *get-ci
      - <<: *get-pull-request
        resource: ledger-pull-request
        passed: [ledger-consumer-pact-test]
      - <<: *put-pact-provider-pending-status
        put: ledger-pull-request
      - get: card-connector-master
      - <<: *pact-provider-test-preflight-check
        params:
          consumer: ledger
      - <<: *pact-provider-verification
        task: connector provider pact verification
        input_mapping:
          test_target: card-connector-master
        params:
          consumer: ledger
          provider: connector
        on_failure:
          <<: *put-pact-provider-failed-status
          put: ledger-pull-request
      - <<: *put-pact-provider-success-status
        put: ledger-pull-request

  - <<: *job-definition
    name: ledger-card-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        resource: ledger-pull-request
        trigger: false
        passed: [ledger-unit-test]
      - <<: *get-ci
      - <<: *put-card-e2e-pending-status
        put: ledger-pull-request
      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: ledger
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/ledger: local_image
        params:
          app_name: ledger
          test_type: card
        on_failure:
          <<: *put-card-e2e-failed-status
          put: ledger-pull-request
      - <<: *put-card-e2e-success-status
        put: ledger-pull-request

  - <<: *job-definition
    name: record-ledger-build-time
    plan:
    - <<: *get-pull-request
      resource: ledger-pull-request
      passed: [ledger-unit-test, ledger-integration-test,
        ledger-pact-provider-test, ledger-consumer-pact-test,
        ledger-pact-provider-verification]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: publicauth-unit-test
    serial_groups: [unit-test]
    plan:
    - <<: *get-pull-request
      resource: publicauth-pull-request
    - <<: *get-ci
    - <<: *put-unit-tests-pending-status
      put: publicauth-pull-request
    - <<: *run-java-unit-test
      params:
        app_name: publicauth
      on_failure:
        <<: *put-unit-test-failed-status
        put: publicauth-pull-request
    - <<: *put-unit-test-success-status
      put: publicauth-pull-request

  - <<: *job-definition
    name: publicauth-integration-test
    serial_groups: [integration-test]
    plan:
    - <<: *get-pull-request
      resource: publicauth-pull-request
    - <<: *put-integration-test-pending-status
      put: publicauth-pull-request
    - <<: *get-ci
    - <<: *run-java-integration-tests
      on_failure:
        <<: *put-integration-test-failed-status
        put: publicauth-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: publicauth
    - <<: *put-integration-test-success-status
      put: publicauth-pull-request

  - <<: *job-definition
    name: publicauth-card-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        resource: publicauth-pull-request
        trigger: false
        passed: [publicauth-unit-test]
      - <<: *get-ci
      - <<: *put-card-e2e-pending-status
        put: publicauth-pull-request
      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: publicauth
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/publicauth: local_image
        params:
          app_name: publicauth
          test_type: card
        on_failure:
          <<: *put-card-e2e-failed-status
          put: publicauth-pull-request
      - <<: *put-card-e2e-success-status
        put: publicauth-pull-request

  - <<: *job-definition
    name: record-publicauth-build-time
    plan:
    - <<: *get-pull-request
      resource: publicauth-pull-request
      passed: [publicauth-unit-test, publicauth-integration-test]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: products-unit-test
    serial_groups: [unit-test]
    plan:
    - <<: *get-pull-request
      resource: products-pull-request
    - <<: *get-ci
    - <<: *put-unit-tests-pending-status
      put: products-pull-request
    - <<: *run-java-unit-test
      params:
        app_name: products
      on_failure:
        <<: *put-unit-test-failed-status
        put: products-pull-request
    - <<: *put-unit-test-success-status
      put: products-pull-request

  - <<: *job-definition
    name: products-integration-test
    serial_groups: [integration-test]
    plan:
    - <<: *get-pull-request
      resource: products-pull-request
    - <<: *put-integration-test-pending-status
      put: products-pull-request
    - <<: *get-ci
    - <<: *run-java-integration-tests
      on_failure:
        <<: *put-integration-test-failed-status
        put: products-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: products
    - <<: *put-integration-test-success-status
      put: products-pull-request


  - <<: *job-definition
    name: products-pact-provider-test
    serial_groups: [pact-test]
    plan:
    - <<: *get-pull-request
      resource: products-pull-request
    - <<: *put-pact-provider-pending-status
      put: products-pull-request
    - <<: *get-ci
    - <<: *pact-provider-test-preflight-check
    - <<: *pact-provider-verification
      input_mapping:
        test_target: src
      params:
        provider: products
      on_failure:
        <<: *put-pact-provider-failed-status
        put: products-pull-request
    - <<: *put-pact-provider-success-status
      put: products-pull-request

  - <<: *job-definition
    name: products-products-e2e
    serial_groups: [e2e-test]
    plan:
      - <<: *get-pull-request
        resource: products-pull-request
        trigger: false
        passed: [products-unit-test]
      - <<: *get-ci
      - <<: *put-products-e2e-pending-status
        put: products-pull-request
      - <<: *run-java-package
      - <<: *build-docker-image
        params:
          app_name: products
      - <<: *get-all-docker-images
      - <<: *run-e2e
        input_mapping:
          docker/products: local_image
        params:
          app_name: products
          test_type: products
        on_failure:
          <<: *put-products-e2e-failed-status
          put: products-pull-request
      - <<: *put-products-e2e-success-status
        put: products-pull-request

  - <<: *job-definition
    name: record-products-build-time
    plan:
    - <<: *get-pull-request
      resource: products-pull-request
      passed: [products-unit-test, products-integration-test,
        products-pact-provider-test]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: card-frontend-test
    serial_groups: [node-test]
    plan:
    - <<: *get-pull-request
      resource: card-frontend-pull-request
    - <<: *get-ci
    - <<: *put-test-pending-status
      put: card-frontend-pull-request
    - <<: *node-test
      on_failure:
        <<: *put-test-failed-status
        put: card-frontend-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: frontend
    - <<: *put-test-success-status
      put: card-frontend-pull-request

  - <<: *job-definition
    name: card-frontend-card-e2e
    serial_groups: [e2e-test]
    plan:
    - <<: *get-ci
    - <<: *get-pull-request
      resource: card-frontend-pull-request
      trigger: false
    - <<: *put-card-e2e-pending-status
      put: card-frontend-pull-request
    - <<: *node-build
      on_failure:
        <<: *put-card-e2e-failed-status
        put: card-frontend-pull-request
    - <<: *build-docker-image
      params:
        app_name: frontend
    - <<: *get-all-docker-images
    - <<: *run-e2e
      input_mapping:
        docker/frontend: local_image
      params:
        app_name: frontend
        test_type: card
      on_failure:
        <<: *put-card-e2e-failed-status
        put: card-frontend-pull-request
    - <<: *put-card-e2e-success-status
      put: card-frontend-pull-request

  - name: card-frontend-pact-provider-verification
    serial_groups: [pact-test]
    plan:
    - <<: *get-ci
    - <<: *get-pull-request
      resource: card-frontend-pull-request
      passed: [card-frontend-test]
    - <<: *put-pact-provider-pending-status
      put: card-frontend-pull-request
    - get: card-connector-master
    - <<: *pact-provider-test-preflight-check
      params:
        consumer: frontend
    - <<: *pact-provider-verification
      task: connector provider pact verification
      input_mapping:
        test_target: card-connector-master
      params:
        consumer: frontend
        provider: connector
      on_failure:
        <<: *put-pact-provider-failed-status
        put: card-frontend-pull-request
    - <<: *put-pact-provider-success-status
      put: card-frontend-pull-request

  - <<: *job-definition
    name: record-frontend-build-time
    plan:
    - <<: *get-pull-request
      resource: card-frontend-pull-request
      passed: [card-frontend-test, card-frontend-pact-provider-verification]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: selfservice-test
    serial_groups: [node-test]
    plan:
    - <<: *get-pull-request
      resource: selfservice-pull-request
    - <<: *get-ci
    - <<: *put-test-pending-status
      put: selfservice-pull-request
    - <<: *node-test
      on_failure:
        <<: *put-test-failed-status
        put: selfservice-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: selfservice
    - <<: *put-test-success-status
      put: selfservice-pull-request

  - <<: *job-definition
    name: selfservice-card-e2e
    serial_groups: [e2e-test]
    plan:
    - <<: *get-ci
    - <<: *get-pull-request
      resource: selfservice-pull-request
      trigger: false
    - <<: *put-card-e2e-pending-status
      put: selfservice-pull-request
    - <<: *node-build
      on_failure:
        <<: *put-card-e2e-failed-status
        put: selfservice-pull-request
    - <<: *build-docker-image
      params:
        app_name: selfservice
    - <<: *get-all-docker-images
    - <<: *run-e2e
      input_mapping:
        docker/selfservice: local_image
      params:
        app_name: selfservice
        test_type: card
      on_failure:
        <<: *put-card-e2e-failed-status
        put: selfservice-pull-request
    - <<: *put-card-e2e-success-status
      put: selfservice-pull-request

  - <<: *job-definition
    name: selfservice-pact-provider-verification
    serial_groups: [pact-test]
    plan:
    - <<: *get-pull-request
      resource: selfservice-pull-request
      passed: [selfservice-test]
    - <<: *put-pact-provider-pending-status
      put: selfservice-pull-request
    - get: card-connector-master
    - get: ledger-master
    - get: adminusers-master
    - get: products-master
    - <<: *get-ci
    - <<: *pact-provider-test-preflight-check
      params:
        consumer: selfservice
    - in_parallel:
      - <<: *pact-provider-verification
        task: connector provider pact verification
        input_mapping:
          test_target: card-connector-master
        params:
          consumer: selfservice
          provider: connector
      - <<: *pact-provider-verification
        task: adminusers provider pact verification
        input_mapping:
          test_target: adminusers-master
        params:
          consumer: selfservice
          provider: adminusers
      - <<: *pact-provider-verification
        task: ledger provider pact verification
        input_mapping:
          test_target: ledger-master
        params:
          consumer: selfservice
          provider: ledger
      - <<: *pact-provider-verification
        task: products provider pact verification
        input_mapping:
          test_target: products-master
        params:
          consumer: selfservice
          provider: products
      on_failure:
        <<: *put-pact-provider-failed-status
        put: selfservice-pull-request
    - <<: *put-pact-provider-success-status
      put: selfservice-pull-request

  - <<: *job-definition
    name: record-selfservice-build-time
    plan:
    - <<: *get-pull-request
      resource: selfservice-pull-request
      passed: [selfservice-test, selfservice-pact-provider-verification]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: toolbox-test
    plan:
    - <<: *get-pull-request
      resource: toolbox-pull-request
    - <<: *get-ci
    - <<: *put-test-pending-status
      put: toolbox-pull-request
    - <<: *node-test
      on_failure:
        <<: *put-test-failed-status
        put: toolbox-pull-request
    - <<: *put-test-success-status
      put: toolbox-pull-request

  - <<: *job-definition
    name: record-toolbox-build-time
    plan:
    - <<: *get-pull-request
      resource: toolbox-pull-request
      passed: [toolbox-test]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: products-ui-test
    serial_groups: [node-test]
    plan:
    - <<: *get-pull-request
      resource: products-ui-pull-request
    - <<: *get-ci
    - <<: *put-test-pending-status
      put: products-ui-pull-request
    - <<: *node-test
      on_failure:
        <<: *put-test-failed-status
        put: products-ui-pull-request
    - <<: *publish-pacts
      params:
        consumer_name: products-ui
    - <<: *put-test-success-status
      put: products-ui-pull-request

  - <<: *job-definition
    name: products-ui-products-e2e
    serial_groups: [e2e-test]
    plan:
    - <<: *get-ci
    - <<: *get-pull-request
      resource: products-ui-pull-request
      trigger: false
    - <<: *put-products-e2e-pending-status
      put: products-ui-pull-request
    - <<: *node-build
      on_failure:
        <<: *put-products-e2e-failed-status
        put: products-ui-pull-request
    - <<: *build-docker-image
      params:
        app_name: products-ui
    - <<: *get-all-docker-images
    - <<: *run-e2e
      input_mapping:
        docker/products-ui: local_image
      params:
        app_name: productsui
        test_type: products
      on_failure:
        <<: *put-products-e2e-failed-status
        put: products-ui-pull-request
    - <<: *put-products-e2e-success-status
      put: products-ui-pull-request

  - <<: *job-definition
    name: products-ui-pact-provider-verification
    serial_groups: [pact-test]
    plan:
    - <<: *get-ci
    - <<: *get-pull-request
      resource: products-ui-pull-request
      passed: [products-ui-test]
    - <<: *put-pact-provider-pending-status
      put: products-ui-pull-request
    - get: products-master
    - get: adminusers-master
    - <<: *pact-provider-test-preflight-check
      params:
        consumer: products-ui
    - in_parallel:
      - <<: *pact-provider-verification
        task: products provider pact verification
        input_mapping:
          test_target: products-master
        params:
          consumer: products-ui
          provider: products
      - <<: *pact-provider-verification
        task: adminusers provider pact verification
        input_mapping:
          test_target: adminusers-master
        params:
          consumer: products-ui
          provider: adminusers
      on_failure:
        <<: *put-pact-provider-failed-status
        put: products-ui-pull-request
    - <<: *put-pact-provider-success-status
      put: products-ui-pull-request

  - <<: *job-definition
    name: record-products-ui-build-time
    plan:
    - <<: *get-pull-request
      resource: products-ui-pull-request
      passed: [products-ui-test, products-ui-pact-provider-verification]
    - <<: *send-pr-build-time

  - <<: *job-definition
    name: ci-pr-test
    plan:
    - <<: *get-pull-request
      resource: ci-pull-request
    - <<: *put-test-pending-status
      put: ci-pull-request
    - task: check pipelines & tasks
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: golang
            tag: 1.14-alpine
        inputs:
          - name: src
        run:
          path: sh
          dir: src
          args:
            - -ec
            - |
              apk add git shellcheck
              go get github.com/alphagov/paas-cf/tools/pipecleaner
              pipecleaner --rubocop=false ci/pipelines/*.yml ci/tasks/*.yml
      on_failure:
        <<: *put-test-failed-status
        put: ci-pull-request
    - <<: *put-test-success-status
      put: ci-pull-request

  - <<: *job-definition
    name: stubs-test
    plan:
    - <<: *get-pull-request
      trigger: true
      resource: stubs-pull-request
    - <<: *get-ci
    - <<: *put-test-pending-status
      put: stubs-pull-request
    - task: run tests
      config:
        platform: linux
        image_resource:
          type: registry-image
          source:
            repository: node
            tag: 12-stretch
        inputs:
          - name: src
        run:
          path: sh
          dir: src
          args:
            - -ec
            - |
              npm ci
              npm test
      on_failure:
        <<: *put-test-failed-status
        put: stubs-pull-request
    - <<: *put-test-success-status
      put: stubs-pull-request

  - <<: *job-definition
    name: record-stubs-build-time
    plan:
    - <<: *get-pull-request
      resource: stubs-pull-request
      passed: [stubs-test]
    - <<: *send-pr-build-time

  - name: update-pr-ci-pipeline
    plan:
      - get: pr-ci-pipeline
        trigger: true
      - set_pipeline: pr-ci
        file: pr-ci-pipeline/ci/pipelines/pr.yml
