#!/bin/ash
# shellcheck shell=dash
set -euo pipefail

FILE_NAME=$(ls reports)

echo "Vulnerability scan report file name: $FILE_NAME .."

JIRA_API_BASE64_TOKEN=$(echo -n "${JIRA_API_USERNAME}:${JIRA_API_TOKEN}" | base64 -w 0)

response=$(curl --fail --request POST \
  --url "$JIRA_BASE_URL/rest/api/3/issue" \
  --header "Authorization: Basic $JIRA_API_BASE64_TOKEN" \
  --header 'Accept: application/json' \
  --header 'Content-Type: application/json' \
  --data "{
    \"fields\": {
      \"description\": {
        \"content\": [
          {
            \"content\": [
              {
                \"text\": \"Triage the internal vulnerability scan for $(date +%m)/$(date +%Y) (attached).\",
                \"type\": \"text\"
              }
            ],
            \"type\": \"paragraph\"
          }
        ],
        \"type\": \"doc\",
        \"version\": 1
      },
      \"issuetype\": {
        \"id\": \"10001\"
      },
      \"labels\": [
        \"Starling\",
        \"Expedite\",
        \"Triage\"
      ],
      \"parent\": {
        \"key\": \"PP-6607\"
      },
      \"project\": {
        \"id\": \"10000\"
      },
      \"summary\": \"Triage $(date +%m)/$(date +%Y) Internal Vulnerability Scan\"
    },
    \"update\": {}
  }")

key=$(echo "$response" | jq --raw-output '.key')

echo "Created JIRA story to triage vulnerability scan report - ${key} .."

curl --silent --output /dev/null --show-error --fail \
  --request POST \
  --url "$JIRA_BASE_URL/rest/api/3/issue/$key/attachments" \
  --header "Authorization: Basic $JIRA_API_BASE64_TOKEN" \
  --header 'X-Atlassian-Token: no-check' \
  --form "file=@\"reports/$FILE_NAME\""

echo "Attached vulnerability scan report to the JIRA story - ${key} .."

echo "$JIRA_BASE_URL/browse/$key" >jira-story/jira-story-link
