# shellcheck shell=dash
set -euo pipefail

JIRA_API_BASE64_TOKEN=$(echo -n "${JIRA_API_USERNAME}:${JIRA_API_TOKEN}" | base64 -w 0)


TMPFILE=$(mktemp)
cat >> "$TMPFILE" <<EOF
{
  "fields": {
    "description": {
      "content": [
        {
          "content": [
            {
              "text": "We have to review the SG and network diagrams as a regular 6 month task\nWe have a ",
              "type": "text"
            },
            {
              "text": "manual page on generating SG diagrams",
              "type": "text",
              "marks": [{
                "type": "link",
                "attrs": {
                  "href": "https://manual.payments.service.gov.uk/manual/manage-environments/generate-a-security-group-diagram.html",
                  "title": "team manual page"
                }
              }]
            },
            {
              "text": "\n\nAcceptance Criteria\n",
              "type": "text",
              "marks": [{"type": "strong"}]
            },
            {
              "text": "- We have reviewed the ",
              "type": "text"
            },
            {
              "text": "network diagrams on the Firewall and Configuration Management page\n",
              "type": "text",
              "marks": [{
                "type": "link",
                "attrs": {
                  "href": "https://manual.payments.service.gov.uk/manual/policies-and-procedures/firewall-configuration-and-management.html#environment-diagrams",
                  "title": "team manual page"
                }
              }]
            },
            {
              "text": "- We have generated and reviewed new security group diagrams for ",
              "type": "text"
            },
            {
              "text": "concourse ",
              "type": "text",
              "marks": [{
                "type": "link",
                "attrs": {
                  "href": "https://manual.payments.service.gov.uk/manual/policies-and-procedures/firewall-configuration-and-management.html#concourse-cd-deployment-environment",
                  "title": "team manual page"
                }
              }]
            },
            {
              "text": "and ",
              "type": "text"
            },
            {
              "text": "production\n",
              "type": "text",
              "marks": [{
                "type": "link",
                "attrs": {
                  "href": "https://manual.payments.service.gov.uk/manual/policies-and-procedures/firewall-configuration-and-management.html#gov-uk-pay-app-production-environment",
                  "title": "team manual page"
                }
              }]
            },
            {
              "text": "- The review date of the Firewall and Configuration Management page has been updated\n- A new entry in the history in the firewall and configuration management page has been entered\n- We have informed Adam Clark in the #govuk-pay-pci channel once the rest is done.",
              "type": "text"
            }
          ],
          "type": "paragraph"
        }
      ],
      "type": "doc",
      "version": 1
    },
    "issuetype": {
      "id": "10001"
    },
    "labels": [
      "Starling",
      "Expedite"
    ],
    "project": {
      "id": "10000"
    },
    "summary": "6 month review of network and SG diagrams - $(date +%b) $(date +%Y)"
  },
  "update": {}
}
EOF

response=$(curl --fail --request POST \
  --url "$JIRA_BASE_URL/rest/api/3/issue" \
  --header "Authorization: Basic $JIRA_API_BASE64_TOKEN" \
  --header 'Accept: application/json' \
  --header 'Content-Type: application/json' \
  --data "@$TMPFILE")

key=$(echo "$response" | jq --raw-output '.key')

echo "Created JIRA story to review network diagram - ${key} .."
echo "$JIRA_BASE_URL/browse/$key" >jira-story/jira-story-link
